<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSI300逆神奇公式半年轮动 - 策略详情</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 30px;
            line-height: 1.8;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .meta { color: #888; margin-bottom: 30px; font-size: 0.9rem; }
        .section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            font-size: 1.2rem;
            color: #00d4ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .section p, .section pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #ccc;
        }
        pre {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .back-btn:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.2); color: #00d4ff; }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-btn">← 返回列表</a>
        <h1>CSI300逆神奇公式半年轮动</h1>
        <p class="meta">
            ID: d749de42 | 
            类型: 多因子选股 | 
            来源: b2324_32.最适合上班族的策略-神奇公式策略.txt |
            分析日期: 2026-01-11 18:13:47
        </p>

        <div class="section">
            <h2>策略逻辑概要</h2>
            <p>在沪深 300 成分股中，以 PE 倒数(1/PE) 与 ROA 的双因子进行分排名，将两项排名相加后再取排名最高（代码里实际上是“最差”）的 30 只股票，并在半年维度（240 交易日选股、120 天建仓、240 天卖出）进行轮动；辅以个股/组合止盈止损。</p>
        </div>

        <div class="section">
            <h2>股票池</h2>
            <p>先限定为沪深 300 成分股；之后过滤停牌、退市、ST、涨停限制，最终股票池理论容量 ≈300。无市值、流动性、上市天数等其他限制。</p>
        </div>

        <div class="section">
            <h2>买入信号</h2>
            <p>当 buy_refresh_rate=120 天触发且当前持仓数 &lt; g.max_hold_stocknum=10, 股票位于最新一次 get_top_30() 生成的候选列表</p>
        </div>

        <div class="section">
            <h2>卖出信号</h2>
            <p>sell_refresh_rate=240 天触发的定期清仓（sell_will_buy == True，默认全部卖出后再买入）, 风控函数 security_stoploss(10%)、security_stopprofit(30%)、portfolio_stoploss(20%)、portfolio_stopprofit(100%) 触发时立即清仓</p>
        </div>

        <div class="section">
            <h2>仓位管理</h2>
            <p>• 单票上限 50%（g.security_max_proportion=0.5）
• 最大持仓 10 只
• 默认按 g.order_style_str=&#x27;by_amount&#x27; 每票买 1000 股（cap at judge_security_max_proportion + max_buy_value/amount 限制）
• 组合级、个股级止盈止损如上；当日若触发风险则不再开仓。</p>
        </div>

        <div class="section">
            <h2>交易频率</h2>
            <p>选股刷新 240 交易日（约 1 年）、买入检查 120 日（约半年）、卖出检查 240 日。所有委托在每日开盘 run_daily(&#x27;open&#x27;) 的 trade() 中 market order 送出。</p>
        </div>

        <div class="section">
            <h2>手动执行指南</h2>
            <p>盘前：每半年运行一次选股脚本并生成最新版 30 只股票清单。
盘中：开盘后按脚本执行买卖委托，需关注是否触发止盈止损。
盘后：检查 selled_security_list_count() 更新的禁买天数、确认组合风控状态。</p>
        </div>

        <div class="section">
            <h2>代码审计详情</h2>
            <p>暂无显式 future_price 使用，但 get_fundamentals(…, date=context.previous_date) 可能仍拿到当期尚未披露的财务数据；排名对整个沪深 300 当日一次性完成，若财务库在回测中默认使用未来已知值则构成泄漏。</p>
        </div>

        <div class="section">
            <h2>灰色区域警告</h2>
            <p>财务数据可得性滞后假设未处理, 排名逻辑把高 PE / 低 ROA 选入，和经典神奇公式相反, 止盈止损函数来自外部库，需确认实盘可用</p>
        </div>

        <div class="section">
            <h2>执行分析</h2>
            <p>低频、大盘股、仓位分散，容量友好；唯一工程难点是财报滞后处理。</p>
        </div>

        <div class="section">
            <h2>10万资金场景</h2>
            <p>一次买 10×1000 股≈100w 市值顶仓＝超出资金，需按资金比例调整；实际 10w 只能持 1~2 只，容量充足。</p>
        </div>

        <div class="section">
            <h2>100万资金场景</h2>
            <p>10×1000 股≈100w，完全可成交，滑点极低。</p>
        </div>

        <div class="section">
            <h2>1000万资金场景</h2>
            <p>需放大每票股数；仍在大盘股容量范围，冲击可控。</p>
        </div>

        <div class="section">
            <h2>1亿资金场景</h2>
            <p>1 亿资金需扩充持仓或提高股数；单票 5000~10000 万时部分成份股也可承载，但组合分散度仅 10 只可能带来冲击，建议扩大持仓数量。</p>
        </div>

        <div class="section">
            <h2>大资金不友好原因</h2>
            <p>大盘股 + 低频，容量充足；大资金友好度较高 → 低分。</p>
        </div>

        <div class="section">
            <h2>行为偏差利用原因</h2>
            <p>纯基本面因子，未直接利用市场情绪。</p>
        </div>

        <div class="section">
            <h2>跨阶段稳健性原因</h2>
            <p>经典 Value+Quality 因子具有一定长期有效性，但代码逻辑排名方向错误，稳定性存疑。</p>
        </div>

        <div class="section">
            <h2>最差环境</h2>
            <p>价值风格失效/成长暴涨, 财务造假频发导致 PE/ROA 失真</p>
        </div>

        <div class="section">
            <h2>可验证预测</h2>
            <p>选股组合市值、PE、ROA 全体分布显著不同于沪深 300, 回测收益主要来源于估值修复, 低换手带来的 alpha&gt;beta 贡献</p>
        </div>

        <div class="section">
            <h2>一句话总结</h2>
            <p>低频大盘 Magic Formula 策略易执行，但当前实现疑似选入高 PE、低 ROA 股，逻辑方向需核对；同时需处理财报滞后以规避未来函数风险。</p>
        </div>

        <div class="section">
            <h2>优化建议</h2>
            <p>1) 把 PE 和 ROA 排名由“越好越小”改为 ascending 排序再求和值；2) 将固定股数买入改为等权或市值加权；3) 引入市值、流动性过滤防止尾部流动性问题；4) 增加财报滞后期。</p>
        </div>

        <div class="section">
            <h2>假设条件</h2>
            <p>假设1: JoinQuant fundamental API 在 date 参数下返回的是当日已披露的历史财报，否则存在未来函数风险, 假设2: 实盘下 MarketOrderStyle() 能在集合竞价或竞价阶段全部成交，不考虑成交量限制</p>
        </div>

        <div class="section">
            <h2>评分汇总</h2>
            <table>
                <tr><th>指标</th><th>分数</th></tr>
                <tr><td>未来函数风险</td><td>6</td></tr>
                <tr><td>滑点</td><td>3</td></tr>
                <tr><td>成本</td><td>3</td></tr>
                <tr><td>执行难度</td><td>8</td></tr>
                <tr><td>时间敏感性</td><td>3</td></tr>
                <tr><td>综合可执行性</td><td>6.7</td></tr>
                <tr><td>大资金不友好</td><td>3</td></tr>
                <tr><td>行为偏差利用</td><td>3</td></tr>
                <tr><td>跨阶段稳健性</td><td>5</td></tr>
                <tr><td>有效性总分</td><td>3.9</td></tr>
                <tr><td>总分</td><td>51.5</td></tr>
            </table>
        </div>

        <div class="section">
            <h2>原始AI响应</h2>
            <pre>```json
{
    &quot;strategy_name&quot;: &quot;CSI300逆神奇公式半年轮动&quot;,
    &quot;strategy_type&quot;: &quot;多因子选股&quot;,
    
    &quot;strategy_explanation&quot;: {
        &quot;core_logic&quot;: &quot;在沪深 300 成分股中，以 PE 倒数(1/PE) 与 ROA 的双因子进行分排名，将两项排名相加后再取排名最高（代码里实际上是“最差”）的 30 只股票，并在半年维度（240 交易日选股、120 天建仓、240 天卖出）进行轮动；辅以个股/组合止盈止损。&quot;,
        &quot;data_and_indicators&quot;: &quot;• 财务因子：PE、ROA（indicator.roa）——通过 get_fundamentals，按上一交易日 previous_date 调用，日频刷新但财报本身为季度。\n• 价格数据：开盘价、涨跌停价、停复牌状态等 —— 实时(日内 open 钩子) 获取。\n• 技术/行情筛选函数框架存在，但目前均注释未启用。&quot;,
        &quot;stock_pool&quot;: &quot;先限定为沪深 300 成分股；之后过滤停牌、退市、ST、涨停限制，最终股票池理论容量 ≈300。无市值、流动性、上市天数等其他限制。&quot;,
        &quot;buy_signals&quot;: [&quot;当 buy_refresh_rate=120 天触发且当前持仓数 &lt; g.max_hold_stocknum=10&quot;, &quot;股票位于最新一次 get_top_30() 生成的候选列表&quot;],
        &quot;sell_signals&quot;: [&quot;sell_refresh_rate=240 天触发的定期清仓（sell_will_buy == True，默认全部卖出后再买入）&quot;, &quot;风控函数 security_stoploss(10%)、security_stopprofit(30%)、portfolio_stoploss(20%)、portfolio_stopprofit(100%) 触发时立即清仓&quot;],
        &quot;position_and_risk&quot;: &quot;• 单票上限 50%（g.security_max_proportion=0.5）\n• 最大持仓 10 只\n• 默认按 g.order_style_str=&#x27;by_amount&#x27; 每票买 1000 股（cap at judge_security_max_proportion + max_buy_value/amount 限制）\n• 组合级、个股级止盈止损如上；当日若触发风险则不再开仓。&quot;,
        &quot;trading_frequency&quot;: &quot;选股刷新 240 交易日（约 1 年）、买入检查 120 日（约半年）、卖出检查 240 日。所有委托在每日开盘 run_daily(&#x27;open&#x27;) 的 trade() 中 market order 送出。&quot;,
        &quot;manual_execution_guide&quot;: &quot;盘前：每半年运行一次选股脚本并生成最新版 30 只股票清单。\n盘中：开盘后按脚本执行买卖委托，需关注是否触发止盈止损。\n盘后：检查 selled_security_list_count() 更新的禁买天数、确认组合风控状态。&quot;
    },
    
    &quot;future_function_detection&quot;: {
        &quot;has_future_function&quot;: &quot;不确定&quot;,
        &quot;risk_level&quot;: &quot;中&quot;,
        &quot;risk_score&quot;: 6,
        &quot;risk_score_reason&quot;: &quot;暂无显式 future_price 使用，但 get_fundamentals(…, date=context.previous_date) 可能仍拿到当期尚未披露的财务数据；排名对整个沪深 300 当日一次性完成，若财务库在回测中默认使用未来已知值则构成泄漏。&quot;,
        &quot;detailed_analysis&quot;: {
            &quot;price_data_leak&quot;: &quot;未见使用未来 K 线；trade() 在 open 钩子——合法。&quot;,
            &quot;financial_data_leak&quot;: &quot;get_fundamentals(date=t-1) 若回测引擎直接返回最新已披露而非截面可得值，会把未来财报带回过去；缺乏披露滞后处理。&quot;,
            &quot;index_component_leak&quot;: &quot;get_index_stocks(&#x27;000300&#x27;, date=end_date) 合规，因 CSI300 成份股历史成份可调，但若未传 date 则潜在用最新成份（已传 end_date）。&quot;,
            &quot;backtest_engine_leak&quot;: &quot;无明显调用 history()/attribute_history 未来窗口；风险集中在财务因子可得性层面。&quot;
        },
        &quot;fix_suggestions&quot;: &quot;1) 使用 fundamental API 的 statDate 或 quarterly 数据并手动滞后一个财务披露窗口（例如 T+60）\n2) 用 declared_date 字段过滤未披露数据\n3) 回测时强制使用 is_displayed=True 的历史财报表。&quot;,
        &quot;gray_area_warnings&quot;: [&quot;财务数据可得性滞后假设未处理&quot;, &quot;排名逻辑把高 PE / 低 ROA 选入，和经典神奇公式相反&quot;, &quot;止盈止损函数来自外部库，需确认实盘可用&quot;]
    },
    
    &quot;execution_difficulty&quot;: {
        &quot;slippage_score&quot;: 3,
        &quot;slippage_reason&quot;: &quot;目标股票为沪深 300 大盘股，成交量充足；开盘价市价单平均滑点有限；脚本设置 FixedSlippage(0.02)≈0.02 元。&quot;,
        &quot;cost_score&quot;: 3,
        &quot;cost_reason&quot;: &quot;120~240 天换手一次，年化换手率 &lt;200%；佣金 0.03%，印花税 0.1% 仅卖出端，总成本低。&quot;,
        &quot;execution_score&quot;: 8,
        &quot;execution_reason&quot;: &quot;最多 10 只大盘股，1000 股/笔；10 万~1000 万资金均易成交。&quot;,
        &quot;time_sensitivity_score&quot;: 3,
        &quot;time_sensitivity_reason&quot;: &quot;仅日级开盘交易，对执行时点要求不高。&quot;,
        &quot;overall_executability&quot;: 8,
        &quot;overall_reason&quot;: &quot;低频、大盘股、仓位分散，容量友好；唯一工程难点是财报滞后处理。&quot;,
        &quot;scenario_analysis&quot;: {
            &quot;10w&quot;: &quot;一次买 10×1000 股≈100w 市值顶仓＝超出资金，需按资金比例调整；实际 10w 只能持 1~2 只，容量充足。&quot;,
            &quot;100w&quot;: &quot;10×1000 股≈100w，完全可成交，滑点极低。&quot;,
            &quot;1000w&quot;: &quot;需放大每票股数；仍在大盘股容量范围，冲击可控。&quot;,
            &quot;1y&quot;: &quot;1 亿资金需扩充持仓或提高股数；单票 5000~10000 万时部分成份股也可承载，但组合分散度仅 10 只可能带来冲击，建议扩大持仓数量。&quot;
        },
        &quot;improvement_suggestions&quot;: [&quot;按资金比例均衡（by_cap_mean）替代固定 1000 股&quot;, &quot;增加财务披露滞后处理防止未来函数&quot;]
    },
    
    &quot;effectiveness&quot;: {
        &quot;large_fund_unfriendly_score&quot;: 3,
        &quot;large_fund_unfriendly_reason&quot;: &quot;大盘股 + 低频，容量充足；大资金友好度较高 → 低分。&quot;,
        &quot;behavioral_bias_score&quot;: 3,
        &quot;behavioral_bias_reason&quot;: &quot;纯基本面因子，未直接利用市场情绪。&quot;,
        &quot;cross_period_robustness_score&quot;: 5,
        &quot;cross_period_robustness_reason&quot;: &quot;经典 Value+Quality 因子具有一定长期有效性，但代码逻辑排名方向错误，稳定性存疑。&quot;,
        &quot;effectiveness_total_score&quot;: 3.7,
        &quot;weight_explanation&quot;: &quot;大资金不友好40% (0.4×3) + 行为偏差30% (0.3×3) + 跨阶段稳健性30% (0.3×5) = 3.7&quot;,
        &quot;worst_environments&quot;: [&quot;价值风格失效/成长暴涨&quot;, &quot;财务造假频发导致 PE/ROA 失真&quot;],
        &quot;verifiable_predictions&quot;: [&quot;选股组合市值、PE、ROA 全体分布显著不同于沪深 300&quot;, &quot;回测收益主要来源于估值修复&quot;, &quot;低换手带来的 alpha&gt;beta 贡献&quot;]
    },
    
    &quot;conclusion&quot;: {
        &quot;verdict&quot;: &quot;低频大盘 Magic Formula 策略易执行，但当前实现疑似选入高 PE、低 ROA 股，逻辑方向需核对；同时需处理财报滞后以规避未来函数风险。&quot;,
        &quot;recommendation&quot;: &quot;小仓实测（在修正因子方向和滞后后）&quot;,
        &quot;optimization_suggestions&quot;: &quot;1) 把 PE 和 ROA 排名由“越好越小”改为 ascending 排序再求和值；2) 将固定股数买入改为等权或市值加权；3) 引入市值、流动性过滤防止尾部流动性问题；4) 增加财报滞后期。&quot;
    },
    
    &quot;score_summary&quot;: {
        &quot;future_function_risk&quot;: 6,
        &quot;slippage&quot;: 3,
        &quot;cost&quot;: 3,
        &quot;execution&quot;: 8,
        &quot;time_sensitivity&quot;: 3,
        &quot;executability&quot;: 8,
        &quot;effectiveness_a&quot;: 3,
        &quot;effectiveness_b&quot;: 3,
        &quot;effectiveness_c&quot;: 5,
        &quot;effectiveness_total&quot;: 3.7
    },
    
    &quot;assumptions&quot;: [
        &quot;假设1: JoinQuant fundamental API 在 date 参数下返回的是当日已披露的历史财报，否则存在未来函数风险&quot;,
        &quot;假设2: 实盘下 MarketOrderStyle() 能在集合竞价或竞价阶段全部成交，不考虑成交量限制&quot;
    ]
}
```</pre>
        </div>

    </div>
</body>
</html>