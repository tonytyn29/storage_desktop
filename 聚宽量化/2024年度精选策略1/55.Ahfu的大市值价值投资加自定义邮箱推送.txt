# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/43159
# æ ‡é¢˜ï¼šAhfuçš„å¤§å¸‚å€¼ä»·å€¼æŠ•èµ„åŠ è‡ªå®šä¹‰é‚®ç®±æ¨é€
# ä½œè€…ï¼šä¸å¦‚å®šæŠ•çº³æŒ‡

# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/41921
# æ ‡é¢˜ï¼šå¤§å¸‚å€¼ä»·å€¼æŠ•èµ„ï¼Œä»2005å¹´è‡³ä»Šè¶…é¢ç¨³å®š
# ä½œè€…ï¼šAhfu

# å¯¼å…¥å‡½æ•°åº“
from jqdata import *
import smtplib
from email.mime.text import MIMEText
from email.header import Header
import base64

# åˆå§‹åŒ–å‡½æ•°ï¼Œè®¾å®šåŸºå‡†ç­‰ç­‰
def initialize(context):
    # è®¾å®šæ²ªæ·±300ä½œä¸ºåŸºå‡†
    set_benchmark('000300.XSHG')
	# å¼€å¯åŠ¨æ€å¤æƒæ¨¡å¼(çœŸå®ä»·æ ¼)
    set_option('use_real_price', True)
	#é˜²æ­¢æœªæ¥å‡½æ•°
    set_option("avoid_future_data", True)
	# è¾“å‡ºå†…å®¹åˆ°æ—¥å¿— log.info()
    log.info('åˆå§‹å‡½æ•°å¼€å§‹è¿è¡Œä¸”å…¨å±€åªè¿è¡Œä¸€æ¬¡')
	# è¿‡æ»¤æ‰orderç³»åˆ—APIäº§ç”Ÿçš„æ¯”errorçº§åˆ«ä½çš„log
    log.set_level('order', 'error')
	
	# è‚¡ç¥¨è¶…å‚æ•°
    g.buy_stock_count = 5
    g.check_out_lists = []
    g.high_limit_list = []
    g.hold_list = []
    # é‚®ç®±ç›¸å…³å‚æ•° ###
    g.open_gmail = False #True/False æ‰“å¼€/å…³é—­é‚®ä»¶åŠŸèƒ½
    g.gmail_host="smtp.163.com"  #ä½ çš„é‚®ç®±æœåŠ¡å™¨åœ°å€
    g.gmail_port= 25  #smtpæœåŠ¡ç«¯å£é»˜è®¤25
    g.gmail_sender = 'xxxx@163.com'  #ä½ çš„é‚®ç®±
    g.gmail_authcode = 'xxxx'  #æˆæƒç ä¸ºå¼€å¯ç¬¬ä¸‰æ–¹é‚®ä»¶æœåŠ¡åä»å¼¹çª—æç¤ºä¸­è·å–
    g.gmail_receivers = ['xxxx@163.com','xxxx@qq.com']   #è¦å‘é€çš„é‚®ç®±åˆ—è¡¨
	### è‚¡ç¥¨ç›¸å…³è®¾å®š ###
    set_order_cost(OrderCost(close_tax=0.001, open_commission=0.00012, close_commission=0.00012, min_commission=5),
				   type='stock')
	
	# å¼€ç›˜å‰è¿è¡Œ
    run_daily(prepare_stock_list, time='9:05', reference_security='000300.XSHG')
    run_monthly(before_market_open, 1, time='9:05', reference_security='000300.XSHG')
	# ç›˜ä¸­è¿è¡Œ
    run_monthly(my_trade, 1, time='9:30', reference_security='000300.XSHG')
    run_daily(check_limit_up, time='14:30', reference_security='000300.XSHG')
    # æ¯å‘¨é‚®ä»¶æ€»ç»“
    run_monthly(send_to_mail, -1, time='15:10', reference_security='000300.XSHG')
	# æ”¶ç›˜åè¿è¡Œ
    run_daily(after_market_close, time='after_close', reference_security='000300.XSHG')
	

def prepare_stock_list(context):
    #è·å–å·²æŒæœ‰åˆ—è¡¨
    g.hold_list= []
    for position in list(context.portfolio.positions.values()):
        stock = position.security
        g.hold_list.append(stock)
    #è·å–æ˜¨æ—¥æ¶¨åœåˆ—è¡¨
    if g.hold_list != []:
        df = get_price(g.hold_list, end_date=context.previous_date, frequency='daily', fields=['close','high_limit'], count=1, panel=False, fill_paused=False)
        df = df[df['close'] == df['high_limit']]
        g.high_limit_list = list(df.code)
    else:
        g.high_limit_list = [] 

## å¼€ç›˜æ—¶è¿è¡Œå‡½æ•°
def my_trade(context):
	# ä¹°å–
	adjust_position(context, g.check_out_lists)

## æ”¶ç›˜åè¿è¡Œå‡½æ•°
def after_market_close(context):
	positions_dict = context.portfolio.positions
	for position in list(positions_dict.values()):
	    log.info("å½“å‰æŒä»“:{0}, æ•°é‡:{1}, å¸‚å€¼:{2}, ç›ˆåˆ©ï¼š{3}%, å»ºä»“æ—¶é—´:{4}".format(get_name(position.security), position.total_amount, round(position.value,0), round((position.value-(position.avg_cost*position.total_amount))/(position.avg_cost*position.total_amount)*100,1), position.init_time))
	log.info('#########################################################################################\n\n')


# è‡ªå®šä¹‰ä¸‹å•
# æ ¹æ®Joinquantæ–‡æ¡£ï¼Œå½“å‰æŠ¥å•å‡½æ•°éƒ½æ˜¯é˜»å¡æ‰§è¡Œï¼ŒæŠ¥å•å‡½æ•°ï¼ˆå¦‚order_target_valueï¼‰è¿”å›å³è¡¨ç¤ºæŠ¥å•å®Œæˆ
# æŠ¥å•æˆåŠŸè¿”å›æŠ¥å•ï¼ˆä¸ä»£è¡¨ä¸€å®šä¼šæˆäº¤ï¼‰ï¼Œå¦åˆ™è¿”å›None
def order_target_value_(security, value):
	if value == 0:
		log.debug("å–å‡º %s" % (get_name(security)))
	else:
		log.debug("ä¹°å…¥ %s ï¼Œå¸‚å€¼ï¼š %f" % (get_name(security), value))

	# å¦‚æœè‚¡ç¥¨åœç‰Œï¼Œåˆ›å»ºæŠ¥å•ä¼šå¤±è´¥ï¼Œorder_target_value è¿”å›None
	# å¦‚æœè‚¡ç¥¨æ¶¨è·Œåœï¼Œåˆ›å»ºæŠ¥å•ä¼šæˆåŠŸï¼Œorder_target_value è¿”å›Orderï¼Œä½†æ˜¯æŠ¥å•ä¼šå–æ¶ˆ
	# éƒ¨æˆéƒ¨æ’¤çš„æŠ¥å•ï¼Œèšå®½çŠ¶æ€æ˜¯å·²æ’¤ï¼Œæ­¤æ—¶æˆäº¤é‡>0ï¼Œå¯é€šè¿‡æˆäº¤é‡åˆ¤æ–­æ˜¯å¦æœ‰æˆäº¤
	return order_target_value(security, value)


# å¼€ä»“ï¼Œä¹°å…¥æŒ‡å®šä»·å€¼çš„è¯åˆ¸
# æŠ¥å•æˆåŠŸå¹¶æˆäº¤ï¼ˆåŒ…æ‹¬å…¨éƒ¨æˆäº¤æˆ–éƒ¨åˆ†æˆäº¤ï¼Œæ­¤æ—¶æˆäº¤é‡å¤§äº0ï¼‰ï¼Œè¿”å›True
# æŠ¥å•å¤±è´¥æˆ–è€…æŠ¥å•æˆåŠŸä½†è¢«å–æ¶ˆï¼ˆæ­¤æ—¶æˆäº¤é‡ç­‰äº0ï¼‰ï¼Œè¿”å›False
def open_position(security, value):
	order = order_target_value_(security, value)
	if order != None and order.filled > 0:
		return True
	return False


# å¹³ä»“ï¼Œå–å‡ºæŒ‡å®šæŒä»“
# å¹³ä»“æˆåŠŸå¹¶å…¨éƒ¨æˆäº¤ï¼Œè¿”å›True
# æŠ¥å•å¤±è´¥æˆ–è€…æŠ¥å•æˆåŠŸä½†è¢«å–æ¶ˆï¼ˆæ­¤æ—¶æˆäº¤é‡ç­‰äº0ï¼‰ï¼Œæˆ–è€…æŠ¥å•éå…¨éƒ¨æˆäº¤ï¼Œè¿”å›False
def close_position(position):
	security = position.security
	order = order_target_value_(security, 0)  # å¯èƒ½ä¼šå› åœç‰Œå¤±è´¥
	if order != None:
		if order.status == OrderStatus.held and order.filled == order.amount:
			return True
	
	return False


# äº¤æ˜“
def adjust_position(context, buy_stocks):
    sellbuystocklist=[]
    advlist_s=[]
    for stock in g.hold_list:
        if (stock not in buy_stocks) and (stock not in g.high_limit_list):
            log.info("å–å‡º[%s]" % (stock))
            position = context.portfolio.positions[stock]
            sellbuystocklist.append(stock)
            advlist_s.append("å–å‡º"+str(position.total_amount)+"è‚¡")
            close_position(position)
        else:
            log.info("å·²æŒæœ‰[%s]" % (stock))

	# æ ¹æ®è‚¡ç¥¨æ•°é‡åˆ†ä»“
	# æ­¤å¤„åªæ ¹æ®å¯ç”¨é‡‘é¢å¹³å‡åˆ†é…è´­ä¹°ï¼Œä¸èƒ½ä¿è¯æ¯ä¸ªä»“ä½å¹³å‡åˆ†é…
    position_count = len(context.portfolio.positions)
    if g.buy_stock_count > position_count:
        value = context.portfolio.cash / (g.buy_stock_count - position_count)
        for stock in buy_stocks:
            if stock not in context.portfolio.positions:
                if open_position(stock, value):
                    sellbuystocklist.append(stock)
                    advlist_s.append("ä¹°å…¥"+str(context.portfolio.positions[stock].total_amount)+"è‚¡")
                    if len(context.portfolio.positions) == g.buy_stock_count:
                        break
    send_mail(context,sellbuystocklist,advlist_s,'å¤§å¸‚å€¼ä»·å€¼æŠ•èµ„-è°ƒä»“é€šçŸ¥','è°ƒä»“é€šçŸ¥')

# # é€šè¿‡ä»£ç è¿”å›è‚¡ç¥¨åç§°
def get_name(stk):
    return get_security_info(stk).display_name+':'+stk[:6]
    
def check_limit_up(context):
    now_time = context.current_dt
    nothighlist=[]
    advlist=[]
    if g.high_limit_list != []:
        #å¯¹æ˜¨æ—¥æ¶¨åœè‚¡ç¥¨è§‚å¯Ÿåˆ°å°¾ç›˜å¦‚ä¸æ¶¨åœåˆ™æå‰å–å‡ºï¼Œå¦‚æœæ¶¨åœå³ä½¿ä¸åœ¨åº”ä¹°å…¥åˆ—è¡¨ä»æš‚æ—¶æŒæœ‰
        for stock in g.high_limit_list:
            current_data = get_price(stock, end_date=now_time, frequency='1m', fields=['close','high_limit'], skip_paused=False, fq='pre', count=1, panel=False, fill_paused=True)
            if current_data.iloc[0,0] < current_data.iloc[0,1]:
                log.info("[%s]æ¶¨åœæ‰“å¼€ï¼Œå–å‡º" % (stock))
                position = context.portfolio.positions[stock]
                nothighlist.append(stock)
                advlist.append('å–å‡º'+str(position.total_amount)+"è‚¡")
                close_position(position)
            else:
                log.info("[%s]æ¶¨åœï¼Œç»§ç»­æŒæœ‰" % (stock))
        send_mail(context,nothighlist,advlist,'å¤§å¸‚å€¼ä»·å€¼æŠ•èµ„-è°ƒä»“é€šçŸ¥','æ¶¨åœæ‰“å¼€ï¼Œå–å‡º')


## å¼€ç›˜å‰è¿è¡Œå‡½æ•°
def before_market_open(context):
    g.check_out_lists = []
    current_data = get_current_data()
    check_date = context.previous_date - datetime.timedelta(days=200)
    all_stocks = list(get_all_securities(date=check_date).index)
    # è¿‡æ»¤åˆ›ä¸šæ¿ã€STã€åœç‰Œã€å½“æ—¥æ¶¨åœ
    all_stocks = [stock for stock in all_stocks if not (
            (current_data[stock].day_open == current_data[stock].high_limit) or  # æ¶¨åœå¼€ç›˜
            (current_data[stock].day_open == current_data[stock].low_limit) or  # è·Œåœå¼€ç›˜
            current_data[stock].paused or  # åœç‰Œ
            current_data[stock].is_st or  # ST
            ('ST' in current_data[stock].name) or
            ('*' in current_data[stock].name) or
            ('é€€' in current_data[stock].name) or
            (stock.startswith('30')) or  # åˆ›ä¸š
            (stock.startswith('68')) or  # ç§‘åˆ›
            (stock.startswith('8')) or  # åŒ—äº¤
            (stock.startswith('4'))   # åŒ—äº¤
    )]
    q = query(
        valuation.code, valuation.market_cap, valuation.pe_ratio, income.total_operating_revenue
        ).filter(
        valuation.pb_ratio < 1,
        cash_flow.subtotal_operate_cash_inflow > 1e6,
        indicator.adjusted_profit > 1e6,
        indicator.roa > 0.15,
        indicator.inc_net_profit_year_on_year > 0,
    	valuation.code.in_(all_stocks)
    	).order_by(
    	indicator.roa.desc()
    ).limit(
    	g.buy_stock_count * 3
    )
    
    check_out_lists = list(get_fundamentals(q).code)
    # å–éœ€è¦çš„åªæ•°
    check_out_lists = check_out_lists[:g.buy_stock_count]
    
    g.check_out_lists = check_out_lists
    log.info("ä»Šæ—¥è‚¡ç¥¨æ± ï¼š%s" % g.check_out_lists)
    advlist_t = []
    for sss in check_out_lists:
        advlist_t.append("å¯ä¹°")
    send_mail(context,check_out_lists,advlist_t,'å¤§å¸‚å€¼ä»·å€¼æŠ•èµ„-æœ¬æœˆç­›é€‰','æœ¬æœˆç­›é€‰è‚¡ç¥¨')
    
def send_mail(context,stocklist,advlist,title,info,sumup=""):
    if g.open_gmail==False:
        return False
    # é‚®ç®±é…ç½® ######################
    host=g.gmail_host  #ä½ çš„é‚®ç®±æœåŠ¡å™¨åœ°å€
    port=g.gmail_port  #smtpæœåŠ¡ç«¯å£é»˜è®¤25
    sender =g.gmail_sender  #ä½ çš„é‚®ç®±
    authcode =g.gmail_authcode  #æˆæƒç ä¸ºå¼€å¯ç¬¬ä¸‰æ–¹é‚®ä»¶æœåŠ¡åä»é‚®ç®±æœåŠ¡å•†è·å–
    #è¦å‘é€çš„é‚®ç®±åˆ—è¡¨
    receivers =g.gmail_receivers
    # é‚®ç®±é…ç½® ######################
    
    stockstr = ''
    cont = 1
    for stock in stocklist:
        stockcode = stock.split(".")[0]
        price_now = attribute_history(stock, 1, '1m', 'close')['close'][0]
        stockstr = stockstr+'<p>'+str(cont)+'. ' +get_security_info(stock).display_name+': '+stock+\
                '  æœ€æ–°ä»·ï¼š'+str(price_now)+'</p>'+\
                '<p>'+advlist[cont-1]+'  '+\
                '<a href="https://gushitong.baidu.com/stock/ab-'+stockcode+'">æŸ¥çœ‹ğŸ“–'+\
                '</a></p>'
        
        cont = cont+1
    

    mail_msg = '<p><strong>'+info+'</strong></p>'\
    +'<p>'+str(context.current_dt)+'</p>'\
    +'<p>è‚¡ç¥¨åˆ—è¡¨: </p>'\
    +stockstr+sumup
     
    
    try:
        #ç™»å½•
        smtp = smtplib.SMTP(host, port)  
        smtp.login(sender, authcode)  

        for tomail in receivers:
            message = MIMEText(mail_msg, 'html', 'utf-8')
            fromnick = sender[:sender.find('@')]
            fromnicknamebase64 = base64.b64encode(bytes(fromnick, 'utf-8'))
            fromnickname64str = str(fromnicknamebase64, 'utf-8')
            message['From'] = Header('"=?utf-8?B?'+fromnickname64str+'=?=" <'+sender+'>')
            message['Subject'] = Header(title, 'utf-8')

            nickname = tomail[:tomail.find('@')]
            nicknamebase64 = base64.b64encode(bytes(nickname, 'utf-8'))
            nickname64str = str(nicknamebase64, 'utf-8')
            message['To'] =  Header('"=?utf-8?B?'+nickname64str+'=?=" <'+tomail+'>')

            smtp.sendmail(sender,[tomail], message.as_string())
        print ("é‚®ä»¶å‘é€æˆåŠŸ")
    except smtplib.SMTPException:
        print ("Error: æ— æ³•å‘é€é‚®ä»¶")
    finally:
        # é€€å‡ºæœåŠ¡å™¨
        smtp.quit()

# æ¯æ˜ŸæœŸå‘é€æŠ¥å‘Šé‚®ä»¶
def send_to_mail(context):
    stocklist=[]
    advlist=[]
    for position in list(context.portfolio.positions.values()):
        securities=position.security
        cost=position.avg_cost
        price=position.price
        ret=100*(price/cost-1)
        value=position.value
        amount=position.total_amount 
        
        stocklist.append(securities)
        advlist.append( 'æˆæœ¬ä»·:{}'.format(format(cost,'.2f'))+',ç°ä»·:{}'.format(price)+',æ”¶ç›Šç‡:{}%'.format(format(ret,'.2f'))+',æŒä»“(è‚¡):{}'.format(amount)+',å¸‚å€¼:{}'.format(format(value,'.2f')) )
    sumup = '<p>'+'æ€»èµ„äº§:{}'.format(format(context.portfolio.total_value,'.2f'))+',å¯ç”¨èµ„é‡‘:{}'.format(format(context.portfolio.available_cash,'.2f'))+\
        ',ç´¯è®¡æ”¶ç›Š:{}'.format(format((context.portfolio.total_value/context.portfolio.inout_cash-1)*100,'.2f'))+'%</p>'
    send_mail(context,stocklist,advlist,'å¤§å¸‚å€¼ä»·å€¼æŠ•èµ„-æ¯å‘¨æ€»ç»“æŠ¥å‘Š','æ¯å‘¨æ€»ç»“',sumup)