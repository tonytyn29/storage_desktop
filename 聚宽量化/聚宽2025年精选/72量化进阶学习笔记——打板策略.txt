# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/47147
# æ ‡é¢˜ï¼šé‡åŒ–è¿›é˜¶å­¦ä¹ ç¬”è®°â€”â€”æ‰“æ¿ç­–ç•¥
# ä½œè€…ï¼šHHHğŸŒ³

# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/46412
# æ ‡é¢˜ï¼šWYå¤§ç¥çš„â€œé¦–æ¿ä½å¼€â€ç­–ç•¥å°æ”¹
# ä½œè€…ï¼šè‹—è€å…«

# å…‹éš†è‡ªèšå®½æ–‡ç« ï¼šhttps://www.joinquant.com/post/44901
# æ ‡é¢˜ï¼šé¦–æ¿ä½å¼€ç­–ç•¥
# ä½œè€…ï¼šwywy1995

from jqlib.technical_analysis import *
from jqfactor import *
from jqdata import *
import datetime as dt
import pandas as pd



def initialize(context):
    # ç³»ç»Ÿè®¾ç½®
    set_option('use_real_price', True)
    set_option('avoid_future_data', True)
    log.set_level('system', 'error')
    # æ¯æ—¥è¿è¡Œ
    run_daily(buy, '09:30') #9:25åˆ†çŸ¥é“å¼€ç›˜ä»·åå¯ä»¥æå‰ä¸‹å•
    run_daily(stoploss, '10:30')
    run_daily(stoploss, '13:00')
    run_daily(stoploss, '14:00')
    run_daily(sellNew, 'every_bar')
    # run_daily(sell, '14:50')



# é€‰è‚¡
def buy(context):
    
    # åŸºç¡€ä¿¡æ¯
    date = transform_date(context.previous_date, 'str')
    current_data = get_current_data()
    
    # æ˜¨æ—¥æ¶¨åœåˆ—è¡¨
    initial_list = prepare_stock_list(date)
    hl_list = get_hl_stock(initial_list, date)
    
    if len(hl_list) != 0:    
        # è·å–éè¿æ¿æ¶¨åœçš„è‚¡ç¥¨
        ccd = get_continue_count_df(hl_list, date, 10)
        lb_list = list(ccd.index)
        stock_list = [s for s in hl_list if s not in lb_list]
        
        # è®¡ç®—ç›¸å¯¹ä½ç½®
        rpd = get_relative_position_df(stock_list, date, 60)
        rpd = rpd[rpd['rp'] <= 0.5]
        stock_list = list(rpd.index)
        
        # ä½å¼€
        df =  get_price(stock_list, end_date=date, frequency='daily', fields=['close'], count=1, panel=False, fill_paused=False, skip_paused=True).set_index('code') if len(stock_list) != 0 else pd.DataFrame()
        df['open_pct'] = [current_data[s].day_open/df.loc[s, 'close'] for s in stock_list]
        df = df[(0.96 <= df['open_pct']) & (df['open_pct'] <= 0.97)] #ä½å¼€è¶Šå¤šé£é™©è¶Šå¤§ï¼Œé€‰æ‹©3ä¸ªå¤šç‚¹å³å¯
        stock_list = list(df.index)
        
        # ä¹°å…¥
        if len(context.portfolio.positions) == 0:
            for s in stock_list:
                order_target_value(s, context.portfolio.total_value/len(stock_list))
                print( 'ä¹°å…¥', [get_security_info(s, date).display_name, s])
                print('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”')


# æš‚æ—¶èˆå¼ƒ
def sell(context):
    
    # åŸºç¡€ä¿¡æ¯
    date = transform_date(context.previous_date, 'str')
    current_data = get_current_data()
    
    # æ ¹æ®æ—¶é—´æ‰§è¡Œä¸åŒçš„å–å‡ºç­–ç•¥
    if str(context.current_dt)[-8:] == '11:28:00':
        for s in list(context.portfolio.positions):
            if ((context.portfolio.positions[s].closeable_amount != 0) and (current_data[s].last_price < current_data[s].high_limit) and (current_data[s].last_price > context.portfolio.positions[s].avg_cost)):
                order_target_value(s, 0)
                print( 'æ­¢ç›ˆå–å‡º', [get_security_info(s, date).display_name, s])
                print('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”')
    
    if str(context.current_dt)[-8:] == '14:50:00':
        for s in list(context.portfolio.positions):
            if ((context.portfolio.positions[s].closeable_amount != 0) and (current_data[s].last_price < current_data[s].high_limit)):
                order_target_value(s, 0)
                print( 'æ­¢æŸå–å‡º', [get_security_info(s, date).display_name, s])
                print('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”')

def stoploss(context):
    hold_list = list(context.portfolio.positions)
    current_data = get_current_data()
    # hour = context.current_dt.hour
    # minute = context.current_dt.minute

    for s in hold_list:
        if context.portfolio.positions[s].closeable_amount != 0:
            cost = context.portfolio.positions[s].avg_cost
            price = context.portfolio.positions[s].price
            ret = 100 * (price/cost-1)
            # æ¡ä»¶1ï¼šå·²ç»äºæŸåˆ™ç›´æ¥å–å‡º
            if ret < 0:
                if current_data[s].last_price > current_data[s].low_limit:
                    order_target_value(s, 0)
                    print('æ­¢æŸå–å‡º' + s)
                    print('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”')
    
    

def sellNew(context):
    hold_list = list(context.portfolio.positions)
    current_data = get_current_data()
    hour = context.current_dt.hour
    minute = context.current_dt.minute

    # ------------------å¤„ç†å–å‡º-------------------
    if minute > 50 and hour == 14:
        for s in hold_list:
            # æ¡ä»¶1ï¼šä¸æ¶¨åœ
            if context.portfolio.positions[s].closeable_amount != 0:
                    
                # æ¡ä»¶2.1ï¼šæŒæœ‰ä¸€å®šæ—¶é—´  2å¤©
                start_date = transform_date(context.portfolio.positions[s].init_time, 'str')
                target_date = get_shifted_date(start_date, 2, 'T')
                current_date = transform_date(context.current_dt, 'str')
                    
                # æ¡ä»¶2.2ï¼šå·²ç»äºæŸ
                cost = context.portfolio.positions[s].avg_cost
                price = context.portfolio.positions[s].price
                ret = 100 * (price/cost-1)
                    
                # åœ¨æ»¡è¶³æ¡ä»¶1çš„å‰æä¸‹ï¼Œæ¡ä»¶2ä¸­åªè¦æ»¡è¶³ä¸€ä¸ªå³å–å‡º
                if current_date >= target_date or ret < 0:
                    if current_data[s].last_price > current_data[s].low_limit:
                        order_target_value(s, 0)
                        print('å–å‡º' + s)
                        print('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”')




############################################################################################################################################################################

# å¤„ç†æ—¥æœŸç›¸å…³å‡½æ•°
def transform_date(date, date_type):
    if type(date) == str:
        str_date = date
        dt_date = dt.datetime.strptime(date, '%Y-%m-%d')
        d_date = dt_date.date()
    elif type(date) == dt.datetime:
        str_date = date.strftime('%Y-%m-%d')
        dt_date = date
        d_date = dt_date.date()
    elif type(date) == dt.date:
        str_date = date.strftime('%Y-%m-%d')
        dt_date = dt.datetime.strptime(str_date, '%Y-%m-%d')
        d_date = date
    dct = {'str':str_date, 'dt':dt_date, 'd':d_date}
    return dct[date_type]

def get_shifted_date(date, days, days_type='T'):
    #è·å–ä¸Šä¸€ä¸ªè‡ªç„¶æ—¥
    d_date = transform_date(date, 'd')
    yesterday = d_date + dt.timedelta(-1)
    #ç§»åŠ¨daysä¸ªè‡ªç„¶æ—¥
    if days_type == 'N':
        shifted_date = yesterday + dt.timedelta(days+1)
    #ç§»åŠ¨daysä¸ªäº¤æ˜“æ—¥
    if days_type == 'T':
        all_trade_days = [i.strftime('%Y-%m-%d') for i in list(get_all_trade_days())]
        #å¦‚æœä¸Šä¸€ä¸ªè‡ªç„¶æ—¥æ˜¯äº¤æ˜“æ—¥ï¼Œæ ¹æ®å…¶åœ¨äº¤æ˜“æ—¥åˆ—è¡¨ä¸­çš„indexè®¡ç®—å¹³ç§»åçš„äº¤æ˜“æ—¥        
        if str(yesterday) in all_trade_days:
            shifted_date = all_trade_days[all_trade_days.index(str(yesterday)) + days + 1]
        #å¦åˆ™ï¼Œä»ä¸Šä¸€ä¸ªè‡ªç„¶æ—¥å‘å‰æ•°ï¼Œå…ˆæ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªäº¤æ˜“æ—¥ï¼Œå†å¼€å§‹å¹³ç§»
        else: #å¦åˆ™ï¼Œä»ä¸Šä¸€ä¸ªè‡ªç„¶æ—¥å‘å‰æ•°ï¼Œå…ˆæ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªäº¤æ˜“æ—¥ï¼Œå†å¼€å§‹å¹³ç§»
            for i in range(100):
                last_trade_date = yesterday - dt.timedelta(i)
                if str(last_trade_date) in all_trade_days:
                    shifted_date = all_trade_days[all_trade_days.index(str(last_trade_date)) + days + 1]
                    break
    return str(shifted_date)



# è¿‡æ»¤å‡½æ•°
def filter_new_stock(initial_list, date, days=250):
    d_date = transform_date(date, 'd')
    return [stock for stock in initial_list if d_date - get_security_info(stock).start_date > dt.timedelta(days=days)]

def filter_st_stock(initial_list, date):
    str_date = transform_date(date, 'str')
    if get_shifted_date(str_date, 0, 'N') != get_shifted_date(str_date, 0, 'T'):
        str_date = get_shifted_date(str_date, -1, 'T')
    df = get_extras('is_st', initial_list, start_date=str_date, end_date=str_date, df=True)
    df = df.T
    df.columns = ['is_st']
    df = df[df['is_st'] == False]
    filter_list = list(df.index)
    return filter_list

def filter_kcbj_stock(initial_list):
    return [stock for stock in initial_list if stock[0] != '4' and stock[0] != '8' and stock[:2] != '68']

def filter_paused_stock(initial_list, date):
    df = get_price(initial_list, end_date=date, frequency='daily', fields=['paused'], count=1, panel=False, fill_paused=True)
    df = df[df['paused'] == 0]
    paused_list = list(df.code)
    return paused_list



# æ¯æ—¥åˆå§‹è‚¡ç¥¨æ± 
def prepare_stock_list(date): 
    initial_list = get_all_securities('stock', date).index.tolist()
    initial_list = filter_kcbj_stock(initial_list)
    initial_list = filter_new_stock(initial_list, date)
    initial_list = filter_st_stock(initial_list, date)
    initial_list = filter_paused_stock(initial_list, date)
    return initial_list

# ç­›é€‰å‡ºæŸä¸€æ—¥æ¶¨åœçš„è‚¡ç¥¨
def get_hl_stock(initial_list, date):
    df = get_price(initial_list, end_date=date, frequency='daily', fields=['close','high','high_limit'], count=1, panel=False, fill_paused=False, skip_paused=False)
    df = df.dropna() #å»é™¤åœç‰Œ
    df = df[df['close'] == df['high_limit']]
    hl_list = list(df.code)
    return hl_list

# è®¡ç®—æ¶¨åœæ•°
def get_hl_count_df(hl_list, date, watch_days):
    # è·å–watch_daysçš„æ•°æ®
    df = get_price(hl_list, end_date=date, frequency='daily', fields=['low','close','high_limit'], count=watch_days, panel=False, fill_paused=False, skip_paused=False)
    df.index = df.code
    #è®¡ç®—æ¶¨åœä¸ä¸€å­—æ¶¨åœæ•°ï¼Œä¸€å­—æ¶¨åœå®šä¹‰ä¸ºæœ€ä½ä»·ç­‰äºæ¶¨åœä»·
    hl_count_list = []
    extreme_hl_count_list = []
    for stock in hl_list:
        df_sub = df.loc[stock]
        hl_days = df_sub[df_sub.close==df_sub.high_limit].high_limit.count()
        extreme_hl_days = df_sub[df_sub.low==df_sub.high_limit].high_limit.count()
        hl_count_list.append(hl_days)
        extreme_hl_count_list.append(extreme_hl_days)
    #åˆ›å»ºdfè®°å½•
    df = pd.DataFrame(index=hl_list, data={'count':hl_count_list, 'extreme_count':extreme_hl_count_list})
    return df

# è®¡ç®—è¿æ¿æ•°
def get_continue_count_df(hl_list, date, watch_days):
    df = pd.DataFrame()
    for d in range(2, watch_days+1):
        HLC = get_hl_count_df(hl_list, date, d)
        CHLC = HLC[HLC['count'] == d]
        df = df.append(CHLC)
    stock_list = list(set(df.index))
    ccd = pd.DataFrame()
    for s in stock_list:
        tmp = df.loc[[s]]
        if len(tmp) > 1:
            M = tmp['count'].max()
            tmp = tmp[tmp['count'] == M]
        ccd = ccd.append(tmp)
    if len(ccd) != 0:
        ccd = ccd.sort_values(by='count', ascending=False)    
    return ccd

# è®¡ç®—è‚¡ç¥¨å¤„äºä¸€æ®µæ—¶é—´å†…ç›¸å¯¹ä½ç½®
def get_relative_position_df(stock_list, date, watch_days):
    if len(stock_list) != 0:
        df = get_price(stock_list, end_date=date, fields=['high', 'low', 'close'], count=watch_days, fill_paused=False, skip_paused=False, panel=False).dropna()
        close = df.groupby('code').apply(lambda df: df.iloc[-1,-1])
        high = df.groupby('code').apply(lambda df: df['high'].max())
        low = df.groupby('code').apply(lambda df: df['low'].min())
        result = pd.DataFrame()
        result['rp'] = (close-low) / (high-low)
        return result
    else:
        return pd.DataFrame(columns=['rp'])
